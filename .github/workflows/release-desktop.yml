name: Release Desktop App

on:
  push:
    tags:
      - 'desktop-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.3)'
        required: true

permissions:
  contents: write

jobs:
  release:
    name: Build & Release (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          # macOS x64 on Intel runner (macos-13 retired, use macos-15-intel)
          - name: macOS-x64
            os: macos-15-intel
            arch: x64
          # macOS arm64 on Apple Silicon runner
          - name: macOS-arm64
            os: macos-latest
            arch: arm64
          # Windows x64 (ARM64 users can run x64 version via emulation)
          - name: Windows-x64
            os: windows-latest
            arch: x64
          # Linux
          - name: Linux
            os: ubuntu-latest
            arch: x64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python (for native modules)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT
      
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Cache electron-builder
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
            ~/Library/Caches/electron
            ~/Library/Caches/electron-builder
            ~/AppData/Local/electron/Cache
            ~/AppData/Local/electron-builder/Cache
          key: ${{ runner.os }}-electron-${{ hashFiles('apps/desktop/package.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-
      
      - name: Install system dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build workspace packages
        run: pnpm build
      
      - name: Rebuild native modules (macOS x64)
        if: matrix.name == 'macOS-x64'
        run: |
          cd apps/desktop
          pnpm rebuild
        env:
          npm_config_target_arch: x64
      
      - name: Rebuild native modules (macOS arm64)
        if: matrix.name == 'macOS-arm64'
        run: |
          cd apps/desktop
          pnpm rebuild
        env:
          npm_config_target_arch: arm64
      
      - name: Build Desktop App (macOS x64)
        if: matrix.name == 'macOS-x64'
        run: pnpm package:desktop:mac:x64
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GA_MEASUREMENT_ID: ${{ secrets.GA_MEASUREMENT_ID }}
          GA_API_SECRET: ${{ secrets.GA_API_SECRET }}
      
      - name: Build Desktop App (macOS arm64)
        if: matrix.name == 'macOS-arm64'
        run: pnpm package:desktop:mac:arm64
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GA_MEASUREMENT_ID: ${{ secrets.GA_MEASUREMENT_ID }}
          GA_API_SECRET: ${{ secrets.GA_API_SECRET }}
      
      - name: Rebuild native modules (Windows x64)
        if: matrix.name == 'Windows-x64'
        run: |
          cd apps/desktop
          pnpm rebuild
        env:
          npm_config_target_arch: x64
      
      - name: Build Desktop App (Windows x64)
        if: matrix.name == 'Windows-x64'
        run: pnpm package:desktop:win
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GA_MEASUREMENT_ID: ${{ secrets.GA_MEASUREMENT_ID }}
          GA_API_SECRET: ${{ secrets.GA_API_SECRET }}
      
      
      - name: Build Desktop App (Linux)
        if: matrix.name == 'Linux'
        run: pnpm package:desktop:linux
        env:
          GA_MEASUREMENT_ID: ${{ secrets.GA_MEASUREMENT_ID }}
          GA_API_SECRET: ${{ secrets.GA_API_SECRET }}
      
      - name: List release files (macOS x64)
        if: matrix.name == 'macOS-x64'
        run: ls -lah apps/desktop/release/
      
      - name: Upload artifacts (macOS x64)
        if: matrix.name == 'macOS-x64'
        uses: actions/upload-artifact@v4
        with:
          name: macos-x64-builds
          path: |
            apps/desktop/release/*-macos-x64.dmg
          if-no-files-found: error
      
      - name: List release files (macOS arm64)
        if: matrix.name == 'macOS-arm64'
        run: ls -lah apps/desktop/release/
      
      - name: Upload artifacts (macOS arm64)
        if: matrix.name == 'macOS-arm64'
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-builds
          path: |
            apps/desktop/release/*-macos-arm64.dmg
          if-no-files-found: error
      
      - name: List release files (Windows x64)
        if: matrix.name == 'Windows-x64'
        run: Get-ChildItem -Path apps/desktop/release/ -Recurse
        shell: pwsh
      
      - name: Upload artifacts (Windows x64)
        if: matrix.name == 'Windows-x64'
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-builds
          path: |
            apps/desktop/release/*-windows-x64-setup.exe
            apps/desktop/release/*-win-x64*.zip
          if-no-files-found: error
      
      
      - name: List release files (Linux)
        if: matrix.name == 'Linux'
        run: ls -lah apps/desktop/release/
      
      - name: Upload artifacts (Linux)
        if: matrix.name == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            apps/desktop/release/*.AppImage
            apps/desktop/release/*.deb
          if-no-files-found: error
  
  publish:
    name: Publish Release
    needs: release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure of downloaded files
        run: ls -R artifacts
      
      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/desktop-v}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          # 检查是否为 pre-release 版本 (包含 beta, alpha, rc 等)
          if [[ "$VERSION" =~ (beta|alpha|rc) ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Amux Desktop v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ steps.version.outputs.IS_PRERELEASE }}
          generate_release_notes: true
          files: |
            artifacts/macos-x64-builds/*
            artifacts/macos-arm64-builds/*
            artifacts/windows-x64-builds/*
            artifacts/linux-builds/*
          body: |
            ${{ steps.version.outputs.IS_PRERELEASE == 'true' && '## ⚠️ Pre-release Version

            **This is a pre-release version for testing purposes.**

            - ⚠️ May contain bugs or unstable features
            - 🧪 For testing and feedback only
            - 🚫 Not recommended for production use
            - 📝 Please report any issues you find

            ---

            ' || '## 🎉 Amux Desktop Release' }}
            
            ### 📥 Download
            
            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | **macOS** | Apple Silicon (M1+) | [![Download](https://img.shields.io/badge/Download-DMG-blue?style=for-the-badge&logo=apple)](https://github.com/isboyjc/amux/releases/download/desktop-v${{ steps.version.outputs.VERSION }}/Amux-${{ steps.version.outputs.VERSION }}-macos-arm64.dmg) |
            | **macOS** | Intel | [![Download](https://img.shields.io/badge/Download-DMG-blue?style=for-the-badge&logo=apple)](https://github.com/isboyjc/amux/releases/download/desktop-v${{ steps.version.outputs.VERSION }}/Amux-${{ steps.version.outputs.VERSION }}-macos-x64.dmg) |
            | **Windows** | x64 | [![Download](https://img.shields.io/badge/Download-EXE-blue?style=for-the-badge&logo=windows)](https://github.com/isboyjc/amux/releases/download/desktop-v${{ steps.version.outputs.VERSION }}/Amux-${{ steps.version.outputs.VERSION }}-windows-x64-setup.exe) |
            | **Linux** | x64 (AppImage) | [![Download](https://img.shields.io/badge/Download-AppImage-blue?style=for-the-badge&logo=linux)](https://github.com/isboyjc/amux/releases/download/desktop-v${{ steps.version.outputs.VERSION }}/Amux-${{ steps.version.outputs.VERSION }}-linux-x64.AppImage) |
            | **Linux** | x64 (Debian/Ubuntu) | [![Download](https://img.shields.io/badge/Download-DEB-blue?style=for-the-badge&logo=debian)](https://github.com/isboyjc/amux/releases/download/desktop-v${{ steps.version.outputs.VERSION }}/Amux-${{ steps.version.outputs.VERSION }}-linux-x64.deb) |
            
            ### 📝 Changelog
            
            View [CHANGELOG](https://github.com/isboyjc/amux/blob/main/apps/desktop/CHANGELOG.md) for detailed update information.
            
            ### ⚠️ macOS Security Tips
            
            Since the app is not notarized by Apple, macOS may show "damaged" or "can't be opened" error. Here are three methods to fix it:
            
            **Method 1: Right-click to Open**
            1. Right-click (or Control+Click) on the app icon
            2. Select "Open" from the menu
            3. Click "Open" in the security dialog
            
            **Method 2: System Settings**
            1. Try to open the app (it will be blocked)
            2. Go to `System Settings > Privacy & Security`
            3. Scroll down to find "Amux was blocked" message
            4. Click "Open Anyway"
            5. Click "Open" in the confirmation dialog
            
            **Method 3: Remove Quarantine (Terminal)**
            ```bash
            # Open Terminal and run:
            xattr -cr /Applications/Amux.app
            
            # Or if app is in Downloads folder:
            xattr -cr ~/Downloads/Amux.app
            ```
            
            > **Note**: After using any of these methods, the app will open normally in the future.
            
            ---
            
            ${{ steps.version.outputs.IS_PRERELEASE == 'true' && '## ⚠️ 预发布版本

            **这是一个用于测试的预发布版本。**

            - ⚠️ 可能包含错误或不稳定的功能
            - 🧪 仅用于测试和反馈
            - 🚫 不建议在生产环境使用
            - 📝 请报告您发现的任何问题

            ---

            ' || '## 🎉 Amux Desktop 发布' }}
            
            ### 📥 下载
            
            | 平台 | 架构 | 下载 |
            |------|------|------|
            | **macOS** | Apple Silicon (M1+) | [![下载](https://img.shields.io/badge/下载-DMG-blue?style=for-the-badge&logo=apple)](https://github.com/isboyjc/amux/releases/download/desktop-v${{ steps.version.outputs.VERSION }}/Amux-${{ steps.version.outputs.VERSION }}-macos-arm64.dmg) |
            | **macOS** | Intel | [![下载](https://img.shields.io/badge/下载-DMG-blue?style=for-the-badge&logo=apple)](https://github.com/isboyjc/amux/releases/download/desktop-v${{ steps.version.outputs.VERSION }}/Amux-${{ steps.version.outputs.VERSION }}-macos-x64.dmg) |
            | **Windows** | x64 | [![下载](https://img.shields.io/badge/下载-EXE-blue?style=for-the-badge&logo=windows)](https://github.com/isboyjc/amux/releases/download/desktop-v${{ steps.version.outputs.VERSION }}/Amux-${{ steps.version.outputs.VERSION }}-windows-x64-setup.exe) |
            | **Linux** | x64 (AppImage) | [![下载](https://img.shields.io/badge/下载-AppImage-blue?style=for-the-badge&logo=linux)](https://github.com/isboyjc/amux/releases/download/desktop-v${{ steps.version.outputs.VERSION }}/Amux-${{ steps.version.outputs.VERSION }}-linux-x64.AppImage) |
            | **Linux** | x64 (Debian/Ubuntu) | [![下载](https://img.shields.io/badge/下载-DEB-blue?style=for-the-badge&logo=debian)](https://github.com/isboyjc/amux/releases/download/desktop-v${{ steps.version.outputs.VERSION }}/Amux-${{ steps.version.outputs.VERSION }}-linux-x64.deb) |
            
            ### 📝 更新日志
            
            查看 [CHANGELOG](https://github.com/isboyjc/amux/blob/main/apps/desktop/CHANGELOG.md) 了解详细的更新信息。
            
            ### ⚠️ macOS 安全提示
            
            由于应用未经 Apple 公证，macOS 可能显示"已损坏"或"无法打开"的错误。以下是三种解决方法：
            
            **方法 1：右键打开**
            1. 右键点击（或 Control+点击）应用图标
            2. 从菜单中选择"打开"
            3. 在安全对话框中点击"打开"
            
            **方法 2：系统设置放行**
            1. 尝试打开应用（会被阻止）
            2. 前往 `系统设置 > 隐私与安全性`
            3. 向下滚动找到"已阻止 Amux"的提示
            4. 点击"仍要打开"
            5. 在确认对话框中点击"打开"
            
            **方法 3：移除隔离属性（终端）**
            ```bash
            # 打开终端并运行：
            xattr -cr /Applications/Amux.app
            
            # 或者如果应用在下载文件夹：
            xattr -cr ~/Downloads/Amux.app
            ```
            
            > **注意**：使用任一方法后，应用将可以正常打开。
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
