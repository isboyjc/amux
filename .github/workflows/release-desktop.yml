name: Release Desktop App

on:
  push:
    tags:
      - 'desktop-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.3)'
        required: true

permissions:
  contents: write

jobs:
  release:
    name: Build & Release (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          # macOS x64 on Intel runner
          - name: macOS-x64
            os: macos-13
            arch: x64
          # macOS arm64 on Apple Silicon runner
          - name: macOS-arm64
            os: macos-latest
            arch: arm64
          # Windows
          - name: Windows
            os: windows-latest
            arch: multi
          # Linux
          - name: Linux
            os: ubuntu-latest
            arch: x64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python (for native modules)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT
      
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Cache electron-builder
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
            ~/Library/Caches/electron
            ~/Library/Caches/electron-builder
            ~/AppData/Local/electron/Cache
            ~/AppData/Local/electron-builder/Cache
          key: ${{ runner.os }}-electron-${{ hashFiles('apps/desktop/package.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-
      
      - name: Install system dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build workspace packages
        run: pnpm build
      
      - name: Rebuild native modules (macOS x64)
        if: matrix.name == 'macOS-x64'
        run: |
          cd apps/desktop
          pnpm rebuild
        env:
          npm_config_target_arch: x64
      
      - name: Rebuild native modules (macOS arm64)
        if: matrix.name == 'macOS-arm64'
        run: |
          cd apps/desktop
          pnpm rebuild
        env:
          npm_config_target_arch: arm64
      
      - name: Build Desktop App (macOS x64)
        if: matrix.name == 'macOS-x64'
        run: pnpm package:desktop:mac:x64
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GA_MEASUREMENT_ID: ${{ secrets.GA_MEASUREMENT_ID }}
          GA_API_SECRET: ${{ secrets.GA_API_SECRET }}
      
      - name: Build Desktop App (macOS arm64)
        if: matrix.name == 'macOS-arm64'
        run: pnpm package:desktop:mac:arm64
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GA_MEASUREMENT_ID: ${{ secrets.GA_MEASUREMENT_ID }}
          GA_API_SECRET: ${{ secrets.GA_API_SECRET }}
      
      - name: Build Desktop App (Windows x64)
        if: matrix.name == 'Windows'
        run: |
          cd apps/desktop
          pnpm rebuild
          cd ../..
          pnpm package:desktop:win
        env:
          npm_config_target_arch: x64
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GA_MEASUREMENT_ID: ${{ secrets.GA_MEASUREMENT_ID }}
          GA_API_SECRET: ${{ secrets.GA_API_SECRET }}
      
      - name: Build Desktop App (Windows arm64)
        if: matrix.name == 'Windows'
        run: |
          cd apps/desktop
          pnpm rebuild
          cd ../..
          pnpm package:desktop:win:arm64
        env:
          npm_config_target_arch: arm64
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GA_MEASUREMENT_ID: ${{ secrets.GA_MEASUREMENT_ID }}
          GA_API_SECRET: ${{ secrets.GA_API_SECRET }}
      
      - name: Build Desktop App (Linux)
        if: matrix.name == 'Linux'
        run: pnpm package:desktop:linux
        env:
          GA_MEASUREMENT_ID: ${{ secrets.GA_MEASUREMENT_ID }}
          GA_API_SECRET: ${{ secrets.GA_API_SECRET }}
      
      - name: List release files (macOS x64)
        if: matrix.name == 'macOS-x64'
        run: ls -lah apps/desktop/release/
      
      - name: Upload artifacts (macOS x64)
        if: matrix.name == 'macOS-x64'
        uses: actions/upload-artifact@v4
        with:
          name: macos-x64-builds
          path: |
            apps/desktop/release/*-macos-x64.dmg
          if-no-files-found: error
      
      - name: List release files (macOS arm64)
        if: matrix.name == 'macOS-arm64'
        run: ls -lah apps/desktop/release/
      
      - name: Upload artifacts (macOS arm64)
        if: matrix.name == 'macOS-arm64'
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-builds
          path: |
            apps/desktop/release/*-macos-arm64.dmg
          if-no-files-found: error
      
      - name: List release files (Windows)
        if: matrix.name == 'Windows'
        run: Get-ChildItem -Path apps/desktop/release/ -Recurse
        shell: pwsh
      
      - name: Upload artifacts (Windows)
        if: matrix.name == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            apps/desktop/release/*.exe
            apps/desktop/release/*-win*.zip
          if-no-files-found: error
      
      - name: List release files (Linux)
        if: matrix.name == 'Linux'
        run: ls -lah apps/desktop/release/
      
      - name: Upload artifacts (Linux)
        if: matrix.name == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            apps/desktop/release/*.AppImage
            apps/desktop/release/*.deb
          if-no-files-found: error
  
  publish:
    name: Publish Release
    needs: release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure of downloaded files
        run: ls -R artifacts
      
      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/desktop-v}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          # æ£€æŸ¥æ˜¯å¦ä¸º pre-release ç‰ˆæœ¬ (åŒ…å« beta, alpha, rc ç­‰)
          if [[ "$VERSION" =~ (beta|alpha|rc) ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Amux Desktop v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ steps.version.outputs.IS_PRERELEASE }}
          generate_release_notes: true
          files: |
            artifacts/macos-x64-builds/*
            artifacts/macos-arm64-builds/*
            artifacts/windows-builds/*
            artifacts/linux-builds/*
          body: |
            ${{ steps.version.outputs.IS_PRERELEASE == 'true' && '## âš ï¸ Pre-release Version / é¢„å‘å¸ƒç‰ˆæœ¬

            **This is a pre-release version for testing purposes.**  
            **è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•çš„é¢„å‘å¸ƒç‰ˆæœ¬ã€‚**

            - âš ï¸ May contain bugs or unstable features / å¯èƒ½åŒ…å«é”™è¯¯æˆ–ä¸ç¨³å®šçš„åŠŸèƒ½
            - ğŸ§ª For testing and feedback only / ä»…ç”¨äºæµ‹è¯•å’Œåé¦ˆ
            - ğŸš« Not recommended for production use / ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨
            - ğŸ“ Please report any issues you find / è¯·æŠ¥å‘Šæ‚¨å‘ç°çš„ä»»ä½•é—®é¢˜

            ---

            ' || '## ğŸ‰ Amux Desktop Release' }}
            
            ### ğŸ“¥ Download
            
            Select the appropriate version for your system:
            
            #### macOS
            - **Apple Silicon (M1/M2/M3)**: `Amux-*-macos-arm64.dmg`
            - **Intel Mac**: `Amux-*-macos-x64.dmg`
            
            #### Windows
            - **Windows x64**: `Amux-*-windows-x64-setup.exe`
            - **Windows ARM64**: `Amux-*-windows-arm64-setup.exe`
            
            #### Linux
            - **AppImage (x64)**: `Amux-*-linux-x64.AppImage`
            - **Debian/Ubuntu (x64)**: `Amux-*-linux-x64.deb`
            
            ### ğŸ“ Changelog
            
            View [CHANGELOG](https://github.com/isboyjc/amux/blob/main/apps/desktop/CHANGELOG.md) for detailed update information.
            
            ### âš ï¸ MacOS Security Tips
            
            Since the app is not notarized by Apple, when you run it for the first time:
            1. Right click on the application icon
            2. Select "Open"
            3. Click "Open" in the pop-up dialog box
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
